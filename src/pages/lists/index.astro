---
import Layout from '../../layouts/Layout.astro';
import prisma from '../../lib/prisma';
import { requireAuth } from '../../lib/middleware';

// Require authentication
const user = await requireAuth(Astro);

const lists = await prisma.list.findMany({
  where: { userId: user.id },
  orderBy: { createdAt: 'desc' },
  include: {
    _count: {
      select: { items: true }
    }
  }
});
---

<Layout title="My Lists">
  <div class="max-w-7xl mx-auto">
    <div class="sm:flex sm:items-center">
      <div class="sm:flex-auto">
        <h1 class="text-3xl font-bold text-gray-900">My Lists</h1>
        <p class="mt-2 text-sm text-gray-700">
          All your URL collections in one place.
        </p>
      </div>
      <div class="mt-4 sm:mt-0 sm:ml-16 sm:flex-none">
        <a
          href="/lists/new"
          class="inline-flex items-center justify-center rounded-md border border-transparent bg-purple-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 sm:w-auto"
        >
          Create New List
        </a>
      </div>
    </div>

    <div class="mt-8 flow-root">
      <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
        <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
          {lists.length === 0 ? (
            <div class="text-center">
              <h3 class="mt-2 text-sm font-semibold text-gray-900">No lists</h3>
              <p class="mt-1 text-sm text-gray-500">Get started by creating a new list.</p>
              <div class="mt-6">
                <a
                  href="/lists/new"
                  class="inline-flex items-center rounded-md bg-purple-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-purple-700"
                >
                  <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                  </svg>
                  New List
                </a>
              </div>
            </div>
          ) : (
            <table class="min-w-full divide-y divide-gray-300">
              <thead>
                <tr>
                  <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-0">Title</th>
                  <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">URLs</th>
                  <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Status</th>
                  <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Created</th>
                  <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-0">
                    <span class="sr-only">Actions</span>
                  </th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200">
                {lists.map((list) => (
                  <tr>
                    <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-0">
                      <a href={`/lists/${list.autoGeneratedUrl}`} class="hover:text-purple-600">
                        {list.title || 'Untitled List'}
                      </a>
                    </td>
                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">{list._count.items} URLs</td>
                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                      <span class={`inline-flex items-center rounded-full px-2 py-1 text-xs font-medium ${list.isPublished ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>
                        {list.isPublished ? 'Published' : 'Draft'}
                      </span>
                    </td>
                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                      {new Date(list.createdAt).toLocaleDateString()}
                    </td>
                    <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-0">
                      <a href={`/lists/${list.autoGeneratedUrl}`} class="text-purple-600 hover:text-purple-900">
                        Edit<span class="sr-only">, {list.title}</span>
                      </a>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </div>
      </div>
    </div>
  </div>
</Layout>
